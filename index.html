<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <title>딥 프리다이빙 맞춤형 트레이닝 스케줄러</title>
  <style>
    /* --- 기본 Styles --- */
    body { background: linear-gradient(to bottom, #c3e0f7, #2d8cd5, #0c4ea2); min-height: 100vh; font-family: Arial, sans-serif; margin: 0; padding: 0; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
    .text-center { text-align: center; }
    .text-white { color: white; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-8 { margin-bottom: 2rem; }
    .text-4xl { font-size: 2.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-xl { font-size: 1.25rem; }
    .font-bold { font-weight: bold; }
    .bg-white { background-color: white; }
    .bg-opacity-90 { background-color: rgba(255, 255, 255, 0.9); }
    .rounded-lg { border-radius: 0.5rem; }
    .p-6 { padding: 1.5rem; }
    .grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1.5rem; }
    @media (min-width: 768px) { #inputSection .grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } }
    @media (min-width: 1024px) { #inputSection .grid { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 768px) { #scheduleContainer.grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1200px) { #scheduleContainer.grid { grid-template-columns: repeat(3, 1fr); } }
    .text-blue-800 { color: #2c5282; }
    .mb-2 { margin-bottom: 0.5rem; }
    .w-full { width: 100%; }
    .p-2 { padding: 0.5rem; }
    .border { border: 1px solid; }
    .border-gray-300 { border-color: #e2e8f0; }
    .rounded { border-radius: 0.25rem; }
    .mt-6 { margin-top: 1.5rem; }
    .bg-blue-600 { background-color: #3182ce; }
    .bg-blue-600:hover { background-color: #2c5282; }
    .bg-print-600 { background-color: #38a169; }
    .bg-print-600:hover { background-color: #276749; }
    .bg-purple-600 { background-color: #805ad5; }
    .bg-purple-600:hover { background-color: #6b46c1; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .text-gray-700 { color: #4a5568; }
    .cursor-pointer { cursor: pointer; }

    /* --- 주의사항 & 영양팁 컨테이너 공통 스타일 --- */
    #trainingPrecautionsContainer,
    #generalNutritionTipsContainer {
      background-color: rgba(255, 255, 255, 0.88);
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      display: none; /* 기본 숨김 */
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #trainingPrecautionsContainer h4,
    #generalNutritionTipsContainer h4 {
      font-size: 1.15rem;
      margin-top: 0;
      margin-bottom: 0.85rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.6rem;
    }
    #trainingPrecautionsContainer ul,
    #generalNutritionTipsContainer ul {
      padding-left: 1.2rem;
      margin: 0;
      font-size: 0.9rem;
      color: #4a5568;
    }
    #trainingPrecautionsContainer li,
    #generalNutritionTipsContainer li {
       margin-bottom: 0.4rem;
       line-height: 1.5;
    }
    /* 주의사항 제목/리스트 스타일 */
    #trainingPrecautionsContainer h4 { color: #c53030; }
    #trainingPrecautionsContainer ul { list-style-type: '⚠️ '; color: #525252; }
    /* 영양팁 리스트 스타일 */
    #generalNutritionTipsContainer ul { list-style-type: '💡 '; }

    /* --- 스케줄 카드 스타일 --- */
    .schedule-card { background-color: rgba(255, 255, 255, 0.9); border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; display: flex; flex-direction: column;}
    .day-title { background-color: #0c4ea2; color: white; border-radius: 10px 10px 0 0; padding: 8px 15px; font-weight: bold; flex-shrink: 0; }
    .dry-day { background-color: #A0AEC0; }
    .openwater-day-title { background-color: #1e6091; }
    .restricted-day-title { background-color: #3182ce; }
    .card-content { padding: 15px; flex-grow: 1; }
    .list-disc { list-style-type: none; padding-left: 0; margin-top: 0.5rem; margin-bottom: 0.5rem;}
    .list-disc li { margin-bottom: 0.75rem; }
    .list-disc label { display: flex; align-items: flex-start; cursor: pointer; }
    .exercise-checkbox { margin-right: 0.6rem; margin-top: 0.2rem; flex-shrink: 0; }
    .exercise-text { flex-grow: 1; }
    .exercise-details { margin-left: 1.8rem; }
    .exercise-info, .nutrition-info { font-size: 0.85rem; color: #5a67d8; margin-top: 4px; font-style: italic; }
    .exercise-category, .nutrition-category { background-color: #e6f0ff; padding: 6px 12px; border-radius: 5px; margin-top: 12px; margin-bottom: 8px; font-weight: bold; color: #2b4f76; }
    .difficulty-info { color: #e03c31; font-style: italic; font-size: 0.85rem; margin-top: 4px; }
    .caution { color: #b91c1c; font-style: italic; font-size: 0.85rem; margin-top: 4px; }
    .sets { font-size: 0.85rem; color: #2b6cb0; font-weight: bold; margin-left: 0.3rem;}
    .duration { font-size: 0.85rem; color: #2b6cb0; font-style: italic; margin-left: 0.3rem;}
    .rest-info { font-style: italic; color: #4a5568; margin-bottom: 10px; }

    /* --- 기타 UI --- */
    .button-row { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; }
    .button-row button { flex: 1; min-width: 200px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; max-width: 500px; width: 90%; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .share-option { display: block; margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.3s; }
    .share-option:hover { background-color: #f5f5f5; }
    .loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center; }
    .loader-content { background-color: white; padding: 2rem; border-radius: 0.5rem; text-align: center; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 1rem auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .training-selection { margin-top: 1rem; margin-bottom: 1rem; padding: 1rem; background-color: #f8fafd; border-radius: 0.5rem; }
    .training-selection h3 { margin-top: 0; margin-bottom: 0.75rem; color: #2c5282; font-size: 1.1rem; }
    .training-selection label { display: inline-block; margin-right: 1rem; margin-bottom: 0.5rem; cursor: pointer; }
    .training-selection input[type="checkbox"] { margin-right: 0.3rem; }
    .nutrition-item { margin-bottom: 0.75rem; }
    .nutrition-item strong { color: #1a365d; }


    /* --- Print Styles --- */
    @media print {
      body { background: none !important; color: black !important; font-size: 10pt; margin: 0; padding: 0; }
      .container { max-width: 100%; padding: 1cm; box-shadow: none; border: none; }
      body > .container > .text-center.mb-8, #inputSection, #shareModal, #loader, .button-row button.bg-purple-600 { display: none !important; }
      #printHeaderInfo { display: block !important; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc; text-align: center; font-size: 10pt; line-height: 1.6; }
      #printHeaderInfo h1 { font-size: 16pt; margin-bottom: 10px; color: black; }
      /* 인쇄 시 주의사항 & 영양팁 스타일 */
      #trainingPrecautionsContainer,
      #generalNutritionTipsContainer { display: block !important; background: #f8f8f8 !important; border: 1px solid #eee !important; padding: 0.8rem 1rem !important; margin-bottom: 15px !important; border-radius: 0 !important; page-break-inside: avoid; }
      #trainingPrecautionsContainer h4,
      #generalNutritionTipsContainer h4 { font-size: 11pt !important; color: black !important; border-bottom: 1px solid #ccc !important; padding-bottom: 4px !important; margin-bottom: 6px !important; }
      #trainingPrecautionsContainer ul,
      #generalNutritionTipsContainer ul { list-style-type: disc !important; font-size: 9pt !important; color: black !important; padding-left: 20px !important; }
      #trainingPrecautionsContainer li,
      #generalNutritionTipsContainer li { margin-bottom: 3px !important; line-height: 1.4; }

      #scheduleContainer { display: block !important; gap: 0; }
      .schedule-card { box-shadow: none !important; border: 1px solid #ccc !important; margin-bottom: 10px !important; page-break-inside: avoid !important; background: white !important; border-radius: 0 !important; }
      .day-title { background: #eee !important; color: black !important; border-radius: 0 !important; border-bottom: 1px solid #ccc !important; padding: 6px 10px !important; font-size: 11pt !important; }
      .day-title.dry-day::before { content: "[드라이 데이] "; font-weight: normal; }
      .day-title.openwater-day-title::before { content: "[개방수역 훈련 포함] "; font-weight: normal; }
      .day-title.restricted-day-title::before { content: "[제한수역 훈련 포함] "; font-weight: normal; }
      .day-title:not(.dry-day):not(.openwater-day-title):not(.restricted-day-title)::before { content: "[훈련일] "; font-weight: normal;}
      .card-content { padding: 10px !important; }
      .exercise-category, .nutrition-category { background: #f8f8f8 !important; padding: 4px 8px !important; font-size: 10pt !important; border-radius: 0 !important; border: 1px solid #eee; }
      ul, li { color: black !important; }
      ul.list-disc { padding-left: 0 !important; list-style-type: none !important; margin-top: 4px; margin-bottom: 8px; }
      .list-disc li label { align-items: flex-start; }
      .exercise-checkbox { appearance: none !important; -webkit-appearance: none !important; display: none !important; }
      .list-disc li label::before { content: "☐"; display: inline-block; font-size: 12pt; margin-right: 8px; vertical-align: middle; line-height: 1; }
      .exercise-details { margin-left: 18px !important; }
      .exercise-info, .nutrition-info, .difficulty-info, .caution { color: #333 !important; font-size: 9pt !important; font-style: italic;}
      .difficulty-info { color: #cc0000 !important; }
      .caution { color: #aa0000 !important; }
      .sets, .duration { color: #333 !important; font-weight: bold !important; font-size: 9pt !important; margin-left: 5px; font-style: normal !important;}
      a { text-decoration: none; color: black; }
    }
  </style>
</head>
<body>
  <div class="container">
     <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-white mb-4">딥 프리다이빙 맞춤형 트레이닝 스케줄러</h1>
      <p class="text-xl text-white mb-6" id="subTitle">개인 목표에 맞춘 훈련 및 영양 계획</p>
    </div>
    <div id="inputSection" class="bg-white bg-opacity-90 rounded-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-4 text-blue-800">트레이닝 계획 생성</h2>
      <div class="grid">
        <div> <label class="block text-gray-700 mb-2" for="userName">이름</label> <input type="text" id="userName" placeholder="이름 입력" class="w-full p-2 border border-gray-300 rounded"> </div>
        <div> <label class="block text-gray-700 mb-2" for="targetDiscipline">주 종목</label> <select id="targetDiscipline" class="w-full p-2 border border-gray-300 rounded"> <option value="CWT">CWT (Constant Weight)</option> <option value="CWTB">CWTB (Constant Weight Bi-Fins)</option> <option value="FIM">FIM (Free Immersion)</option> <option value="CNF">CNF (Constant Weight No Fins)</option> </select> </div>
        <div> <label class="block text-gray-700 mb-2" for="currentPb">현재 PB (m)</label> <input type="number" id="currentPb" placeholder="예: 40" class="w-full p-2 border border-gray-300 rounded" min="5"> </div>
        <div> <label class="block text-gray-700 mb-2" for="targetRecord">목표 수심 (m)</label> <input type="number" id="targetRecord" placeholder="예: 50" class="w-full p-2 border border-gray-300 rounded" min="10"> </div>
        <div> <label class="block text-gray-700 mb-2" for="trainingDays">트레이닝 기간</label> <select id="trainingDays" class="w-full p-2 border border-gray-300 rounded"> <option value="7">7일</option> <option value="10">10일</option> <option value="14" selected>14일</option> <option value="21">21일</option> <option value="30">30일</option> </select> </div>
        <div> <label class="block text-gray-700 mb-2" for="experienceLevel">경험 수준 (자동 제안)</label> <select id="experienceLevel" class="w-full p-2 border border-gray-300 rounded" disabled> <option value="beginner">초급 ( ~25m)</option> <option value="intermediate">중급 (26m ~ 45m)</option> <option value="advanced">고급 (46m+)</option> </select> </div>
        <div> <label class="block text-gray-700 mb-2" for="includeNutrition">영양 관리</label> <select id="includeNutrition" class="w-full p-2 border border-gray-300 rounded"> <option value="yes" selected>식단&영양제 포함</option> <option value="no">훈련 일정만</option> </select> </div>
        <div style="grid-column: span 1 / span 1;"> <label class="block text-gray-700 mb-2" for="includeExplanations">트레이닝 설명</label> <select id="includeExplanations" class="w-full p-2 border border-gray-300 rounded"> <option value="yes" selected>훈련 방법&효과 포함</option> <option value="no">훈련 일정만</option> </select> </div>
      </div>
      <div class="training-selection"> <h3>포함할 훈련 종류 선택</h3> <label><input type="checkbox" name="trainingType" value="breath" checked> 호흡</label> <label><input type="checkbox" name="trainingType" value="pressure" checked> 압력평형</label> <label><input type="checkbox" name="trainingType" value="openWater" checked> 개방수역</label> <label><input type="checkbox" name="trainingType" value="restricted" checked> 제한수역(수영장)</label> <label><input type="checkbox" name="trainingType" value="strength" checked> 체력</label> </div>
      <div class="button-row"> <button onclick="generateScheduleWrapper()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg cursor-pointer">스케줄 생성하기</button> <button onclick="printSchedule()" class="bg-print-600 text-white font-bold py-3 px-6 rounded-lg cursor-pointer">출력하기</button> <button onclick="openShareModal()" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg cursor-pointer">공유하기</button> </div>
    </div>

    <div id="printHeaderInfo" style="display: none;"> <h1 id="printUserNameTitle">님의 딥 프리다이빙 트레이닝 계획</h1> <p id="printParams"></p> </div>

    <div id="trainingPrecautionsContainer">
      </div>

    <div id="generalNutritionTipsContainer"></div>

    <div id="scheduleContainer">
      </div>

  </div> <div id="shareModal" class="modal"> <div class="modal-content"> <span class="close" onclick="closeShareModal()">&times;</span> <h2 class="text-2xl font-bold mb-4">공유하기</h2> <div class="share-option" onclick="shareViaLink()"> <h3 class="font-bold">링크 공유</h3> <p>현재 설정 링크 복사</p> </div> <div class="share-option" onclick="shareViaEmail()"> <h3 class="font-bold">이메일 공유</h3> <p>스케줄 링크 이메일 전송</p> </div> <div class="share-option" onclick="shareViaSocialMedia()"> <h3 class="font-bold">SNS 공유</h3> <p>스케줄 링크 SNS 공유</p> </div> </div> </div>
  <div id="loader" class="loader"> <div class="loader-content"> <div class="spinner"></div> <p id="loaderText">처리 중...</p> </div> </div>

  <script>
    // --- Data Definition (nutrition 수정됨) ---
    const data = {
        breath: [ { name: "패킹 기법 훈련", method: "최종호흡 후 빠르게 입안 공기공간을 만들어 공기 삼키는 것을 반복. 점진적으로 패킹 횟수 늘리기.", effect: "총 폐용적 증가, 공기 저장량 증대, 흉곽 유연성 향상", sets: 3, difficultyAdjustments: { beginner: "가볍게 5-10회 시도, 무리하지 않기", intermediate: "10-15회 목표, 폐 압박감 느끼며 조절", advanced: "15회 이상, 최대 패킹 후 압력 유지 연습" }}, { name: "리버스 패킹 훈련", method: "날숨 이후 입안 공기공간 만든 후 체외로 배출 반복. 점진적으로 리버스 패킹 횟수 늘리기.", effect: "폐 잔기량 감소, 폐 탄성 향상, 압력 변화 적응력 향상", sets: 3, difficultyAdjustments: { beginner: "가볍게 5-10회 시도, 흉곽 수축 느끼기", intermediate: "10-15회 목표, 깊은 날숨 후 수행", advanced: "15회 이상, 최대 리버스 패킹 후 저산소 상태 적응 연습" }}, { name: "카팔라바티 호흡법", method: "빠르고 강한 복부 수축으로 코를 통해 짧게 공기 30회 연속 배출 후 숨참기.", effect: "호흡근 강화, CO₂ 내성 증가, 횡격막 컨트롤 향상", sets: 3, duration: "30회/세트" }, { name: "STA (정적 무호흡)", method: "최종호흡 이후 편안한 자세로 숨참기 실시. 컨트렉션 시작 시간 및 최대 기록 측정.", effect: "무호흡 시간 연장, 저산소/고이산화탄소 내성 강화, 심리적 안정감 증대", sets: 3, difficultyAdjustments: { beginner: "목표: 1분 30초 이상 / 컨트렉션 1회 느끼기", intermediate: "목표: 2분 30초 이상 / 컨트렉션 3-5회 참기", advanced: "목표: 3분 30초 이상 / 강한 컨트렉션에도 이완 유지" }} ],
        pressure: [ { name: "리버스 패킹 & 마우스필", method: "공기 내쉰 후 리버스 패킹하고 마우스필 압력 유지. ", effect: "깊은 수심 압력평형 능력 개선, 마우스필 전환 능력 향상", sets: 3, difficultyAdjustments: { beginner: "마우스필 압력 생성 및 유지 연습 (5-10초)", intermediate: "리버스 패킹 후 마우스필 전환, 압력 유지 시간 늘리기 (15-20초)", advanced: "최대 리버스 패킹 후 마우스필 전환, 강한 압력 유지 및 미세 조절 연습 (20초 이상)" }, tags: ['mouthfill'] }, { name: "볼 부풀리기 & 공기 유지 (마우스필)", method: "최종호흡 후 입안에 공기 가득 채우고(마우스필) 압력 유지. ", effect: "마우스필 압력평형 기술 향상, 볼근육 강화", sets: 3, difficultyAdjustments: { beginner: "압력 약하게 유지 (10-15초)", intermediate: "압력 점진적 증가, 유지 시간 늘리기 (20-30초)", advanced: "최대 압력 유지, 목 움직이며 압력 유지 연습 (30초 이상)" }, tags: ['mouthfill'] }, { name: "성문 부분열기 & 공기 조절", method: "마우스필 상태에서 성문을 약간 열어 연구개로 공기 천천히 새어나오게 조절.", effect: "성문 및 연구개 조절 능력 향상, 마우스필 정밀도 개선", sets: 2, difficultyAdjustments: { beginner: "공기 흐름 느끼기, 짧게 조절 연습", intermediate: "일정한 속도로 공기 흐름 유지 연습", advanced: "매우 느리고 정밀하게 공기 흐름 조절 연습" }}, { name: "마우스필 충전 연습 (EQ Tool/Oto-vent)", method: "EQ Tool 또는 Oto-vent 풍선 불기 활용. 코 막고 입안 압력으로 풍선 부풀리기.", effect: "마우스필 압력 생성 및 이관 개방 능력 향상.", sets: 3, reps: "5-10회 불기", tags: ['mouthfill'], difficultyAdjustments: { intermediate: "부드럽게 불기 연습", advanced: "강한 압력으로 빠르게 불기 연습"} } ],
        openWater: [ { name: "프리이멀션 + 중성부력체크 + 행잉", _template: true, method: "중성부력 수심까지 로프잡고 하강 후 로프 놓고 컨트렉션 확인. 로프잡고 상승하는 연습 포함.", effect: "FIM기술향상, 부력감각 향상, 컨트렉션 적응", sets: 2, difficultyAdjustments: { beginner: "5-10m / 컨트롤된 하강과 부드러운 상승 집중", intermediate: "10-15m / 컨트렉션 발생 시 이완 유지 연습", advanced: "15m 이상 / 컨트렉션 중 이완 유지 및 상승 컨트롤" }}, { name: "목표 종목 PB 다이빙", _template: true, method: "워밍업 후, 선택한 주 종목(CWT/CWTB/FIM/CNF)으로 당일 계산된 목표 수심 범위 내에서 1회 도전.", effect: "심리적 한계 극복 및 점진적 기록 경신 시도, 목표 수심 적응", caution: "컨디션 최상일 때만 시도. 불안, 압력평형 문제, 저체온 등 발생 시 절대 무리하지 말고 즉시 안전하게 상승." }, { name: "CO2 FIM", _template: true, method: "수면에서 버티컬 피닝(다리만) 30초 후 최종호흡, 목표 수심까지 FIM 수행.", effect: "FIM 기술 향상, CO2 내성 증가, 긴장 완화 기술 향상", sets: 3, difficultyAdjustments: { beginner: "목표 수심 10-15m / CO2 축적 느낌 적응", intermediate: "목표 수심 15-25m / 상승 시 CO2 압박 관리 (필요시 상승 약간 참기)", advanced: "목표 수심 25m+ / 강한 컨트렉션 중 기술 유지 (필요시 상승 약간 참기)" }}, { name: "CO2 CWT", _template: true, method: "수면 버티컬 피닝 30초 후 최종호흡, 덕다이빙하여 목표 수심까지 CWT 수행 (바이핀 사용).", effect: "CWT/CWTB 기술 향상, CO2 내성 증가, 다이빙 긴장 완화 기술 향상", sets: 3, difficultyAdjustments: { beginner: "목표 수심 10-15m / CO2 축적 상태에서 덕다이빙 및 피닝", intermediate: "목표 수심 15-25m / 상승 시 CO2 압박 관리 (필요시 상승 약간 참기)", advanced: "목표 수심 25m+ / CO2 내성 한계 경험 및 극복 (필요시 상승 약간 참기)" }}, { name: "CO2 CNF", _template: true, method: "수면 버티컬 피닝 30초 후 최종호흡, 덕다이빙하여 목표 수심까지 CNF 수행 (노핀 스킬 활용).", effect: "CNF 기술 향상, CO2 내성 증가, 마우스필 및 타이밍 조절 능력 향상", sets: 3, difficultyAdjustments: { beginner: "목표 수심 10-15m / CO2 축적 상태에서 노핀 동작 수행", intermediate: "목표 수심 15-20m / 상승 시 CO2 압박 관리 (필요시 상승 약간 참기)", advanced: "목표 수심 20m+ / 강한 컨트렉션 중 기술 유지 및 조절 (필요시 상승 약간 참기)" }}, { name: "FIM -> CWT 전환 훈련", _template: true, method: "개방수역에서 FIM으로 목표 수심까지 하강 후, CWT(바이핀)로 전환하여 상승.", effect: "상황 대처 능력, 종목 전환 적응력 향상", sets: 2, difficultyAdjustments: { beginner: "10-15m / 부드러운 전환 연습", intermediate: "15-25m / 전환 후 안정적인 상승 속도 유지", advanced: "25m+ / 깊은 수심에서 효율적인 전환 및 상승" }}, { name: "FIM -> CNF 전환 훈련", _template: true, method: "개방수역에서 FIM으로 목표 수심까지 하강 후, CNF(노핀)로 전환하여 상승.", effect: "상황 대처 능력, CNF 상승 기술 전환 적응력 향상", sets: 2, difficultyAdjustments: { beginner: "10-15m / 부드러운 노핀 전환 및 상승 시작 연습", intermediate: "15-20m / 전환 후 안정적인 CNF 상승 자세 및 속도 유지", advanced: "20m+ / 깊은 수심에서 효율적인 노핀 전환 및 상승 컨트롤" }} ],
        restricted: [ { name: "워밍업 스트레칭", method: "목, 어깨, 허리, 다리 중심 전신 스트레칭", effect: "유연성 향상, 부상 방지", sets: 1, duration: "10분" }, { name: "가벼운 수영 워밍업", method: "자유형, 평영 등 편안한 영법으로", effect: "심박수 상승, 근육 활성화", distance: "100m", sets: 1 }, { name: "스트림라인 글라이딩", method: "벽 차고 최대한 멀리 에로우 자세(스트림라인)로 글라이딩", effect: "물 저항 최소화 자세 연습, 효율성 증대", sets: 5 }, { name: "다이나믹 핀 킥 연습 (DYN)", _template: true, method: "모노핀 또는 바이핀 착용 후 잠영. 플러터킥, 돌핀킥 등.", effect: "수중 킥 효율성 및 밸런스 개선, 추진력 강화", distance: "25m+", sets: 8, difficultyAdjustments: { beginner: "바이핀 / 자세 유지 및 킥 리듬 집중 (25m)", intermediate: "모노핀 또는 바이핀 / 거리 점진적 증가 (35m+)", advanced: "모노핀 또는 바이핀 / 최소 킥으로 최대 거리 목표 (50m+)" }, tags:['fins']}, { name: "DNF 평영킥 연습", method: "핀 없이 평영킥(Whip kick)만 사용하여 잠영. 글라이딩 극대화.", effect: "DNF 추진력 핵심인 평영킥 효율 증대", distance: "25m", sets: 4, difficultyAdjustments: { beginner: "킥 타이밍과 글라이딩 집중", intermediate: "최소 킥으로 25m 도달 목표", advanced: "킥 파워 및 글라이딩 거리 극대화 (35m+)" }, tags:['dnf', 'cnf_specific', 'kick']}, { name: "DNF 암스트로크 연습", method: "풀부이 등 다리 고정 후 팔(Arm stroke)만 사용하여 잠영.", effect: "DNF 상체 추진력 및 스트림라인 유지 능력 향상", distance: "25m", sets: 4, difficultyAdjustments: { beginner: "정확한 스트로크 자세 연습", intermediate: "연속적인 스트로크와 글라이딩 연결", advanced: "파워풀하고 효율적인 스트로크 (35m+)" }, tags:['dnf', 'cnf_specific', 'arm']}, { name: "DNF 잠영 (노핀 다이나믹)", method: "벽 차기 후 평영킥과 암스트로크를 조합하여 잠영.", effect: "DNF 종합 기술, 협응력, 거리 향상", distance: "25m+", sets: 4, difficultyAdjustments: { beginner: "킥/풀/글라이딩 조합 리듬 연습 (25m)", intermediate: "효율적인 조합으로 거리 증가 시도 (35m+)", advanced: "최소 스트로크/킥으로 최대 거리 목표 (50m+)" }, tags:['dnf', 'cnf_specific']}, { name: "STA 후 DYN/DNF 전환", method: "STA (정적 무호흡) 실시 후 바로 DYN(핀) 또는 DNF(노핀) 수행.", effect: "성문 조절 능력 향상, 저산소 상태 다이나믹 적응", sets: 3, difficultyAdjustments: { beginner: "STA 1:00 후 DYN/DNF 25m", intermediate: "STA 1:30 후 DYN/DNF 35-40m", advanced: "STA 2:00+ 후 DYN/DNF 50m+" }}, { name: "웜다운 수영", method: "편안한 영법으로 천천히 수영하며 심박수 안정", effect: "회복 촉진, 근육 이완", distance: "100m", sets: 1 } ],
        strength: [ { name: "스쿼트 (Squat)", method: "하체 근력 강화 기본 운동.", effect: "핀 킥 파워 향상, 코어 안정성 증가", sets: 3, reps: "12-15회", tags: ['lower', 'core'] }, { name: "런지 (Lunge)", method: "한다리씩 번갈아 진행.", effect: "하체 비대칭 개선, 둔근/허벅지 강화", sets: 3, reps: "각 다리 10-12회", tags: ['lower'] }, { name: "카프 레이즈 (Calf Raise)", method: "발뒤꿈치 들어올려 종아리 자극.", effect: "발목 안정성, 킥 마무리 파워", sets: 3, reps: "20-25회", tags: ['lower'] }, { name: "플랭크 (Plank)", method: "팔꿈치/발끝 지지. 코어 활성화.", effect: "코어 안정성, 수중 자세 유지력", sets: 3, duration: "45-75초", tags: ['core'] }, { name: "백 익스텐션 (Back Extension)", method: "엎드려 상체 들어올려 기립근 강화.", effect: "허리 안정성, 코어 후면 강화", sets: 3, reps: "15-20회", tags: ['core', 'posterior_chain'] }, { name: "러시안 트위스트 (Russian Twist)", method: "앉아서 상체 비틀기. 복사근 강화.", effect: "몸통 회전 안정성, 코어 강화", sets: 3, reps: "20-30회 (왕복)", tags: ['core'] }, { name: "푸쉬업 (Push-up)", method: "가슴, 어깨, 삼두근 강화.", effect: "상체 미는 힘, 코어 보조", sets: 3, reps: "최대 반복 (8회 이상)", tags: ['upper', 'push'] }, { name: "풀업 / 랫풀다운", method: "등, 이두근 강화. 철봉/머신 활용.", effect: "상체 당기는 힘, FIM/CWT 효율성", sets: 3, reps: "8-12회", tags: ['upper', 'pull'] }, { name: "덤벨 숄더 프레스", method: "앉거나 서서 덤벨 위로.", effect: "어깨 근력, 상체 안정성", sets: 3, reps: "10-15회", tags: ['upper', 'push'] }, { name: "인터벌 달리기/사이클", method: "짧은 고강도와 휴식 반복.", effect: "심폐지구력, 무산소성 능력", sets: 1, duration: "15-20분", tags: ['cardio/co2'] } ],
        dryTraining: [ { name: "저산소 트레이닝 (Hypoxic Training)", method: "저산소 마스크 착용 또는 코 호흡 제한하며 걷기/가볍게 달리기, 또는 인터벌 숨참기 포함.", effect: "저산소 적응력 향상, 산소 활용 효율 증대.", duration: "15-25분", sets: 1, caution: "절대 무리 금지, 어지러움 발생 시 즉시 중단 및 휴식. 낮은 강도로 시작.", tags: ['dry', 'cardio/co2'] }, { name: "지속 러닝 (Continuous Run)", method: "일정한 페이스 유지하며 쉬지 않고 달리기.", effect: "유산소 지구력 및 심폐 기능 향상.", duration: "30-45분", sets: 1, difficultyAdjustments: { beginner: "20-30분, 대화 가능 속도", intermediate: "30-40분, 약간 숨찬 속도", advanced: "40분 이상, 목표 페이스 유지" }, tags: ['dry', 'cardio'] }, { name: "숨 참고 걷기 (Breath-hold Walk)", method: "최종 호흡 후 최대한 숨 참고 걷기. 휴식 후 반복.", effect: "CO₂ 내성 증가, 무호흡 움직임 적응력 향상.", sets: 5, duration: "최대한 멀리/오래", rest: "충분한 회복 호흡 (최소 1분 30초)", tags: ['dry', 'co2'] } ],
        nutrition: {
            general: [ { mealTime: "아침", suggestion: "오트밀 (귀리) + 베리류 + 견과류 한 줌", focus: "지속적인 에너지 공급" }, { mealTime: "점심", suggestion: "닭가슴살 샐러드 (퀴노아 또는 통곡물빵) + 올리브 오일 드레싱", focus: "근육 회복 (단백질), 에너지 보충" }, { mealTime: "저녁", suggestion: "두부 채소 볶음 또는 렌틸콩 카레 + 현미밥", focus: "균형잡힌 영양, 근육 회복 지원" } ],
            openWater: [ { mealTime: "아침", suggestion: "통밀 토스트 + 아보카도 + 계란 (훈련 2-3시간 전)", focus: "소화 편한 에너지원" }, { mealTime: "점심", suggestion: "구운 연어 + 고구마 + 브로콜리", focus: "글리코겐 보충, 근회복, 항염" }, { mealTime: "저녁", suggestion: "소고기 또는 닭가슴살 구이 + 퀴노아 + 구운 채소", focus: "단백질 보충 통한 근회복, 복합 탄수화물" } ],
            restricted: [ { mealTime: "아침", suggestion: "그릭 요거트 + 과일 + 그래놀라 (훈련 2시간 전)", focus: "적당량 에너지, 소화 용이" }, { mealTime: "점심", suggestion: "소고기/두부 채소 볶음 + 현미밥", focus: "철분, 단백질, 에너지 보충" }, { mealTime: "저녁", suggestion: "흰살 생선(대구, 조기 등) 찜 + 잡곡밥 + 나물 반찬", focus: "저지방 단백질, 미네랄 보충, 과식 방지" } ],
            recovery: [ { mealTime: "아침", suggestion: "채소 스크램블 에그 + 통밀빵 1쪽", focus: "단백질, 비타민/미네랄 보충" }, { mealTime: "점심", suggestion: "렌틸콩 수프 + 샐러드", focus: "식물성 단백질, 식이섬유, 항산화" }, { mealTime: "저녁", suggestion: "버섯 들깨탕 또는 채소 위주 식단 + 두부", focus: "영양 보충 및 소화 부담 적은 식사" } ],
            supplements: [ { name: "철분 (Iron)", effect: "헤모글로빈 생성 도움, 산소 운반 능력 향상 기여 (빈혈 예방 중요)" }, { name: "마그네슘 (Magnesium)", effect: "근육 이완 및 기능 개선, 신경계 안정 도움 (부족 시 근경련 유발 가능)" }, { name: "오메가-3 (Omega-3 EPA/DHA)", effect: "염증 감소, 심혈관 건강, 혈액 순환 개선 도움 가능성" }, { name: "비트루트 주스/추출물 (Nitrates)", effect: "체내 산화질소(NO) 생성 증가시켜 혈관 확장 및 산소 이용 효율 증대 가능성" }, { name: "코엔자임 Q10 (CoQ10)", effect: "세포 에너지(ATP) 생성 과정 보조 및 항산화 작용" }, { name: "비타민 B 복합체 (B-Complex)", effect: "에너지 대사, 적혈구 형성, 신경 기능 유지에 필수적인 비타민군" }, { name: "비타민 C", effect: "항산화 작용, 면역력 강화, 콜라겐 생성 도움" }, { name: "비타민 E", effect: "강력한 지용성 항산화제, 세포막 보호" }, { name: "아르기닌 / 시트룰린", effect: "산화질소(NO) 생성 촉진하여 혈류 개선, 피로 회복 도움 가능성" } ],
            generalTips: [ "수분 보충: 훈련 전후 및 중간에 충분히 (하루 1.5L 이상 권장).", "식사 시간: 수중 훈련 최소 2-3시간 전 식사 완료.", "가공식품 줄이기: 정제 설탕, 트랜스 지방 피하기.", "다양성: 다양한 채소/과일, 통곡물, 단백질 섭취.", "개인화: 몸 상태와 소화 능력에 맞춰 조절, 필요시 전문가 상담.", "**주의:** 영양제/보충제는 보조 수단이며, 균형 잡힌 식단을 대체할 수 없습니다. 특정 질환이 있거나 약물을 복용 중인 경우, 섭취 전 반드시 의사 또는 약사와 상담하세요." ]
        }
    };

    // --- Helper Functions (동일) ---
    function deepCopy(obj) { try { return JSON.parse(JSON.stringify(obj)); } catch (e) { console.error("Deep copy failed:", e, obj); return obj; } }
    function getRandomItems(array, count) { if (!Array.isArray(array) || array.length === 0 || count <= 0) return []; const copiedArray = deepCopy(array); const shuffled = copiedArray.sort(() => 0.5 - Math.random()); return deepCopy(shuffled.slice(0, Math.min(count, shuffled.length))); }
    function sanitizeForId(str) { if (typeof str !== 'string') return ''; return str.toLowerCase().replace(/[^a-z0-9\-]/g, '-').replace(/^-+|-+$/g, '').replace(/-{2,}/g, '-'); }
    function getNumericInput(id) { try { const input = document.getElementById(id); if (!input) return 0; const value = parseInt(input.value, 10); return !isNaN(value) && value > 0 ? value : 0; } catch (error) { console.error(`Error in getNumericInput for ID '${id}':`, error); return 0; } }

    // --- Update Experience Level (동일) ---
    function updateExperienceLevel() { try { const targetRecordInput = document.getElementById('targetRecord'); const experienceLevelSelect = document.getElementById('experienceLevel'); if (!targetRecordInput || !experienceLevelSelect) return; const targetDepth = parseInt(targetRecordInput.value, 10); if (!isNaN(targetDepth) && targetDepth > 0) { let newLevel = 'beginner'; if (targetDepth > 45) newLevel = 'advanced'; else if (targetDepth > 25) newLevel = 'intermediate'; if (experienceLevelSelect.value !== newLevel) experienceLevelSelect.value = newLevel; } } catch (error) { console.error("Error inside updateExperienceLevel:", error); } }

    // --- Schedule Generation Wrapper (동일) ---
    function generateScheduleWrapper() { console.log("generateScheduleWrapper called"); showLoader("스케줄 생성 중..."); setTimeout(() => { try { generateSchedule(); console.log("generateSchedule completed successfully (within wrapper)."); } catch (error) { console.error("Error caught in generateScheduleWrapper:", error.message); alert(`스케줄 생성 중 오류 발생:\n${error.message}\n\n자세한 내용은 개발자 콘솔(F12)을 확인하세요.`); } finally { hideLoader(); console.log("Loader hidden."); } }, 10); }

    // --- Main Schedule Generation Logic (주의사항 표시 로직 추가됨) ---
    function generateSchedule() {
        console.log("--- generateSchedule started ---");
        // --- Read Inputs & Validation ---
        console.log("Reading inputs..."); const userName = document.getElementById('userName')?.value.trim() || "사용자"; const targetDiscipline = document.getElementById('targetDiscipline')?.value || 'CWT'; const currentPb = getNumericInput('currentPb'); const targetRecord = getNumericInput('targetRecord'); const days = getNumericInput('trainingDays') || 14; const includeNutrition = document.getElementById('includeNutrition')?.value === 'yes'; const includeExplanations = document.getElementById('includeExplanations')?.value === 'yes'; const selectedTrainingTypes = Array.from(document.querySelectorAll('input[name="trainingType"]:checked')).map(cb => cb.value);
        console.log("Performing validation..."); if (targetRecord <= 0) { document.getElementById('targetRecord')?.focus(); throw new Error("유효한 목표 수심(m)을 입력해주세요."); } if (currentPb <= 0) { document.getElementById('currentPb')?.focus(); throw new Error("유효한 현재 PB(m)를 입력해주세요."); } if (currentPb >= targetRecord) { document.getElementById('targetRecord')?.focus(); throw new Error("목표 수심은 현재 PB보다 깊어야 합니다."); } if (days <= 0) { document.getElementById('trainingDays')?.focus(); throw new Error("유효한 트레이닝 기간을 선택해주세요."); } console.log("Validation passed.");
        console.log("Updating and reading experience level..."); updateExperienceLevel(); const level = document.getElementById('experienceLevel')?.value || 'beginner'; console.log(`Inputs Confirmed: User=${userName}, Discipline=${targetDiscipline}, PB=${currentPb}, Target=${targetRecord}, Level=${level}, Days=${days}, SelectedTypes=${selectedTrainingTypes.join(',')}`);
        console.log("Updating subtitle and clearing outputs..."); const subTitleElement = document.getElementById('subTitle'); if (subTitleElement) subTitleElement.textContent = `${userName}님의 ${targetDiscipline} ${currentPb}m -> ${targetRecord}m 도전을 위한 맞춤 계획`; const scheduleContainer = document.getElementById('scheduleContainer'); const nutritionTipsContainer = document.getElementById('generalNutritionTipsContainer'); const precautionsContainer = document.getElementById('trainingPrecautionsContainer'); if (!scheduleContainer || !precautionsContainer || !nutritionTipsContainer) { throw new Error("FATAL: 필수 컨테이너 요소를 찾을 수 없습니다 (schedule, precautions, nutrition)."); } scheduleContainer.innerHTML = ''; if (nutritionTipsContainer) nutritionTipsContainer.innerHTML = ''; if (precautionsContainer) precautionsContainer.innerHTML = ''; scheduleContainer.className = 'grid'; console.log("Outputs cleared.");

        // ******** Display Training Precautions ********
        console.log("Displaying training precautions...");
        if (precautionsContainer) {
            precautionsContainer.style.display = 'block';
            const precautionsTitle = document.createElement('h4'); precautionsTitle.textContent = '🚨 프리다이빙 훈련 주의사항'; precautionsContainer.appendChild(precautionsTitle); const precautionsList = document.createElement('ul'); const precautions = [ "절대 혼자 다이빙하지 마세요. 항상 자격을 갖춘 버디와 함께 하세요.", "몸의 소리에 귀 기울이세요. 피곤하거나 컨디션이 좋지 않다면 절대 무리하지 마세요.", "이퀄라이징(압력 평형)은 부드럽게, 미리 수행하세요. 통증을 느끼면 즉시 상승하세요.", "과호흡(Hyperventilation)은 위험할 수 있습니다. 자격을 갖춘 강사의 지도 없이 과도하게 시도하지 마세요.", "출수 후 회복 호흡(Recovery Breathing) 절차를 반드시 지키세요.", "점진적으로 수심과 시간을 늘려가세요. 급격한 증가는 위험합니다.", "적절한 웨이트(Weighting)를 착용하고 중성 부력을 정확히 확인하세요.", "자신의 한계를 인지하고 절대 무시하지 마세요. (불안감, 추위 등)", "훈련 전후 충분한 휴식을 취하고 수분을 보충하세요.", "공인된 기관의 자격을 갖춘 강사에게 교육을 받으세요.", "수온, 조류, 시야 등 해양 환경 조건을 항상 확인하고 안전을 최우선으로 하세요." ]; precautions.forEach(tip => { const tipLi = document.createElement('li'); tipLi.textContent = tip; precautionsList.appendChild(tipLi); }); precautionsContainer.appendChild(precautionsList);
        } else { console.warn("Training precautions container not found"); }

        // --- Display General Nutrition Tips ---
        if (includeNutrition && data.nutrition?.generalTips) { console.log("Displaying general nutrition tips..."); if (nutritionTipsContainer) { nutritionTipsContainer.style.display = 'block'; const tipsTitle = document.createElement('h4'); tipsTitle.textContent = '일반 영양 팁'; nutritionTipsContainer.appendChild(tipsTitle); const tipsList = document.createElement('ul'); data.nutrition.generalTips.forEach(tip => { const tipLi = document.createElement('li'); tipLi.innerHTML = tip.startsWith("**주의:**") ? `<strong style="color:#B91C1C;">${tip}</strong>` : tip; tipsList.appendChild(tipLi); }); nutritionTipsContainer.appendChild(tipsList); } } else { if (nutritionTipsContainer) nutritionTipsContainer.style.display = 'none'; }

        // --- Determine Open Water Days & Counters (동일) ---
        console.log("Determining open water days pattern..."); const openWaterDayPattern = [2]; let totalOpenWaterDays = 0; if (selectedTrainingTypes.includes('openWater')) { for (let dayIndex = 1; dayIndex <= days; dayIndex++) { const cycleDay = dayIndex % 4; if (cycleDay !== 0 && openWaterDayPattern.includes(cycleDay)) totalOpenWaterDays++; } } console.log("Calculated total Open Water Days:", totalOpenWaterDays); const depthIncrease = targetRecord - currentPb; let openWaterDayCounter = 0; let currentIntermediateTargetPb = currentPb; let dryDayCounter = 0;

        // --- Generate Daily Cards ---
        console.log(`--- Starting daily card generation loop for ${days} days ---`);
        for (let i = 1; i <= days; i++) {
            console.log(`\nProcessing Day ${i}...`); const isDryDay = (i % 4 === 0); const cycleDay = i % 4; const card = document.createElement('div'); card.className = 'schedule-card'; const title = document.createElement('div'); title.className = 'day-title'; const content = document.createElement('div'); content.className = 'card-content'; let exercisesAdded = false; let dayTypeName = "훈련일"; let nutritionPlanKey = 'general';
            try {
                if (isDryDay) { /* ... Dry day logic ... */ dryDayCounter++; title.classList.add('dry-day'); dayTypeName = "드라이 데이"; title.textContent = `DAY ${i} - ${dayTypeName}`; nutritionPlanKey = data.nutrition?.recovery ? 'recovery' : 'general'; console.log(`  Type: Dry Day`); if (data.dryTraining?.length > 0) { const dryTrainIndex = (dryDayCounter - 1) % data.dryTraining.length; if (dryTrainIndex >= 0 && dryTrainIndex < data.dryTraining.length) { const selectedDryTraining = [ deepCopy(data.dryTraining[dryTrainIndex]) ]; console.log(`  Adding Dry Training:`, selectedDryTraining.map(e=>e.name)); addCategoryAndExercises(content, '드라이 트레이닝', selectedDryTraining, includeExplanations, level, i); exercisesAdded = true; } else { console.error(`  Invalid dry training index: ${dryTrainIndex}`); } } else { console.warn("  Dry training data missing or empty."); } }
                else {
                    let addedCategories = []; console.log(`  Type: Training Day (Cycle Day ${cycleDay})`);
                    if (selectedTrainingTypes.includes('breath') && data.breath?.length > 0) { const items = getRandomItems(data.breath, level === 'beginner' ? 1 : 2); console.log(`  Adding Breath (${items.length})`); addCategoryAndExercises(content, '호흡 훈련', items, includeExplanations, level, i); exercisesAdded = true; }
                    if (selectedTrainingTypes.includes('pressure') && data.pressure?.length > 0) { let pressureExercises = []; const mouthfillNeeded = level === 'advanced' || targetRecord > 35; const allPressureExercises = deepCopy(data.pressure); const mouthfillPractice = allPressureExercises.filter(ex => ex.tags?.includes('mouthfill')); const otherPressure = allPressureExercises.filter(ex => !ex.tags?.includes('mouthfill')); if (mouthfillNeeded && mouthfillPractice.length > 0) pressureExercises.push(...getRandomItems(mouthfillPractice, 1)); const remainingCount = mouthfillNeeded ? (mouthfillPractice.length > 0 ? 1 : 2) : (level === 'beginner' ? 1 : 2); pressureExercises.push(...getRandomItems(otherPressure, remainingCount)); pressureExercises = [...new Map(pressureExercises.map(item => [item.name, item])).values()].slice(0,2); if (pressureExercises.length > 0) { console.log(`  Adding Pressure (${pressureExercises.length})`); addCategoryAndExercises(content, '압력평형 훈련', pressureExercises, includeExplanations, level, i); exercisesAdded = true; } }
                    // ******** Modified Restricted Water Logic Call ********
                    const poolDayPattern = [1, 3]; if (selectedTrainingTypes.includes('restricted') && poolDayPattern.includes(cycleDay) && data.restricted?.length > 0) { console.log(`Day ${i}: Adding Restricted Water Training (Discipline: ${targetDiscipline})`); addedCategories.push("제한수역"); nutritionPlanKey = data.nutrition?.restricted ? 'restricted' : 'general'; let restrictedExercises = buildRestrictedExercises(targetDiscipline, level); if (restrictedExercises.length > 0) { console.log(`  Adding Restricted (${restrictedExercises.length}) exercises`); addCategoryAndExercises(content, `제한수역 (${targetDiscipline} 특화)`, restrictedExercises, includeExplanations, level, i); exercisesAdded = true; } }
                    // ******** Modified Open Water Logic Call ********
                    if (selectedTrainingTypes.includes('openWater') && openWaterDayPattern.includes(cycleDay) && data.openWater?.length > 0) { console.log(`Day ${i}: Adding Open Water Training (Discipline: ${targetDiscipline})`); addedCategories.push("개방수역"); nutritionPlanKey = data.nutrition?.openWater ? 'openWater' : 'general'; openWaterDayCounter++; let openWaterExercises = buildOpenWaterExercises(targetDiscipline, level, openWaterDayCounter, totalOpenWaterDays, currentPb, targetRecord, userName); const pbDive = openWaterExercises.find(ex => ex.name.includes("목표: ~")); if(pbDive && pbDive.name.match(/~(\d+)m/)){ currentIntermediateTargetPb = parseInt(pbDive.name.match(/~(\d+)m/)[1], 10); } else { currentIntermediateTargetPb = currentPb; } if (openWaterExercises.length > 0) { console.log(`  Adding OpenWater category with ${openWaterExercises.length} exercises.`); addCategoryAndExercises(content, `개방수역 (${targetDiscipline})`, openWaterExercises, includeExplanations, level, i); exercisesAdded = true; } else { console.warn(`  No Open Water exercises selected or generated for Day ${i}`); } }
                    // Add Strength (동일)
                    if (selectedTrainingTypes.includes('strength') && data.strength?.length > 0) { let strengthFocus = ''; let focusTags = []; const focusCycle = ((i - Math.floor((i-1)/4)) -1) % 3; if (focusCycle === 0) { strengthFocus = '하체 & 코어'; focusTags = ['lower', 'core']; } else if (focusCycle === 1) { strengthFocus = '상체 (Push & Pull)'; focusTags = ['push', 'pull']; } else { strengthFocus = '코어 & Cardio/CO2'; focusTags = ['core', 'cardio/co2', 'posterior_chain']; } const allStrengthExercises = deepCopy(data.strength); const relevantExercises = allStrengthExercises.filter(ex => focusTags.some(tag => ex.tags?.includes(tag))); let prioritizedExercise = null; if (targetDiscipline === 'FIM' && focusTags.includes('pull')) prioritizedExercise = relevantExercises.find(ex => ex.name.includes('풀업') || ex.name.includes('랫풀다운')); else if ((targetDiscipline === 'CWT' || targetDiscipline === 'CWTB') && focusTags.includes('lower')) prioritizedExercise = relevantExercises.find(ex => ex.name.includes('스쿼트') || ex.name.includes('런지')); else if (focusTags.includes('core')) prioritizedExercise = relevantExercises.find(ex => ex.name.includes('플랭크')); let strengthExercises = []; const numStrengthExercises = (level === 'beginner') ? 1 : 2; if (prioritizedExercise) { strengthExercises.push(prioritizedExercise); const remaining = relevantExercises.filter(ex => ex.name !== prioritizedExercise.name); strengthExercises.push(...getRandomItems(remaining, Math.max(0, numStrengthExercises - 1))); } else { strengthExercises = getRandomItems(relevantExercises, numStrengthExercises); } strengthExercises = [...new Map(strengthExercises.map(item => [item.name, item])).values()]; if (strengthExercises.length > 0) { console.log(`  Adding Strength (${strengthExercises.length}) - Focus: ${strengthFocus}`); addCategoryAndExercises(content, `체력 훈련 - ${strengthFocus}`, strengthExercises, includeExplanations, level, i); exercisesAdded = true; } else { console.warn(`  No strength exercises selected for focus: ${strengthFocus}`); } }
                    // Set Title (동일)
                    if (addedCategories.length > 0) { if (addedCategories.includes("개방수역")) title.classList.add("openwater-day-title"); else if (addedCategories.includes("제한수역")) title.classList.add("restricted-day-title"); dayTypeName = addedCategories.join(' & ') + " 훈련"; } else if (exercisesAdded) { dayTypeName = "지상 훈련일"; } else { dayTypeName = "휴식 또는 자율 훈련"; } title.textContent = `DAY ${i} - ${dayTypeName}`;
                } // End Non-Dry Day

                if (!exercisesAdded) { /* Placeholder */ console.log(`  No exercises added for Day ${i}.`); const noExerciseInfo = document.createElement('p'); noExerciseInfo.textContent = '이 날짜에 해당하는 훈련이 없거나 선택되지 않았습니다.'; noExerciseInfo.style.fontStyle = 'italic'; noExerciseInfo.style.color = '#666'; content.appendChild(noExerciseInfo); }
                if (includeNutrition && data.nutrition) { /* Add nutrition */ console.log(`  Adding Nutrition Plan (Key: ${nutritionPlanKey})`); addNutritionPlan(content, nutritionPlanKey, includeExplanations); }

                card.appendChild(title); card.appendChild(content); console.log(`  Appending card for Day ${i}`); scheduleContainer.appendChild(card);
            } catch (dayError) { console.error(`Error processing Day ${i}:`, dayError); /* Handle error display */ const errorMsg = document.createElement('p'); errorMsg.textContent = `[오류 발생: ${dayError.message}]`; errorMsg.style.color = 'red'; errorMsg.style.fontWeight = 'bold'; content.appendChild(errorMsg); if (!title.parentNode) card.appendChild(title); if (!content.parentNode) card.appendChild(content); scheduleContainer.appendChild(card); }
        }
        console.log("--- Schedule generation loop finished ---");
    } // End generateSchedule

    // --- Helper: Build Restricted Exercises (동일) ---
    function buildRestrictedExercises(targetDiscipline, level) { let exercises = []; const warmupItems = data.restricted.filter(ex => ex.name.includes("워밍업") || ex.name.includes("스트레칭")); exercises.push(...deepCopy(warmupItems)); const streamline = data.restricted.find(ex => ex.name.includes("스트림라인")); if(streamline) exercises.push(deepCopy(streamline)); if (targetDiscipline === 'CNF') { const cnfPoolDrills = data.restricted.filter(ex => ex.tags?.includes('cnf_specific')); exercises.push(...getRandomItems(cnfPoolDrills, 2)); } else { const dynType = (targetDiscipline === 'CWTB' || level === 'beginner') ? '바이핀' : '모노핀'; const dynTemplate = data.restricted.find(ex => ex._template && ex.name.includes("다이나믹 핀 킥 연습")); if(dynTemplate){ let dynCopy = deepCopy(dynTemplate); dynCopy.name = `DYN (${dynType}) 연습`; dynCopy.method = `${dynType} 착용 후 잠영. 자세, 킥 효율성, 턴 집중.`; delete dynCopy._template; exercises.push(dynCopy); } } if (level !== 'beginner'){ const staTransition = data.restricted.find(ex => ex.name.includes("STA 후 DYN/DNF 전환")); if(staTransition) exercises.push(deepCopy(staTransition)); } const cooldown = data.restricted.find(ex => ex.name.includes("웜다운")); if (cooldown) exercises.push(deepCopy(cooldown)); return [...new Map(exercises.map(item => [item.name, item])).values()]; }
    // --- Helper: Build Open Water Exercises (동일) ---
    function buildOpenWaterExercises(targetDiscipline, level, openWaterDayCounter, totalOpenWaterDays, currentPb, targetRecord, userName) { let exercises = []; let currentIntermediateTargetPb = currentPb; const depthIncrease = targetRecord - currentPb; const allOpenWaterTemplates = deepCopy(data.openWater.filter(ex => ex._template)); const specificDrills = deepCopy(data.openWater.filter(ex => !ex._template && !ex.name.includes("전환 훈련"))); const fimWarmupTemplate = allOpenWaterTemplates.find(ex => ex.name.includes("프리이멀션")); if (fimWarmupTemplate) { let fimWarmup = deepCopy(fimWarmupTemplate); let fimTargetDepth = Math.round(currentPb * 0.4); if (level === 'advanced') fimTargetDepth = Math.min(25, Math.round(currentPb * 0.5)); else if (level === 'intermediate') fimTargetDepth = Math.min(20, Math.round(currentPb * 0.45)); fimTargetDepth = Math.max(10, fimTargetDepth); let fimTargetRange = `${fimTargetDepth - 3}-${fimTargetDepth}m`; if(fimWarmup.difficultyAdjustments && fimWarmup.difficultyAdjustments[level]){ const effectText = fimWarmup.difficultyAdjustments[level].split('/')[1]?.trim() || '워밍업 및 부력 체크'; fimWarmup.difficultyAdjustments[level] = `${fimTargetRange} / ${effectText}`; } else { if(!fimWarmup.difficultyAdjustments) fimWarmup.difficultyAdjustments = {}; fimWarmup.difficultyAdjustments[level] = `${fimTargetRange} / 워밍업 및 부력 체크`; } delete fimWarmup._template; exercises.push(fimWarmup); } if (level !== 'beginner') { const pbDiveTemplate = allOpenWaterTemplates.find(ex => ex.name.includes("PB 다이빙")); if (pbDiveTemplate) { let pbDive = deepCopy(pbDiveTemplate); let intermediateTarget = currentPb + 1; if (totalOpenWaterDays > 0 && depthIncrease > 0) { const progressFraction = openWaterDayCounter / totalOpenWaterDays; intermediateTarget = Math.round(currentPb + (depthIncrease * progressFraction)); } currentIntermediateTargetPb = Math.min(targetRecord, Math.max(currentPb + 1, intermediateTarget)); pbDive.name = `${userName} ${targetDiscipline} Day ${openWaterDayCounter} 목표: ~${currentIntermediateTargetPb}m`; pbDive.method = `충분한 워밍업 후, ${targetDiscipline}으로 금일 목표 수심(${currentIntermediateTargetPb}m) 도전 (1회). 안전 절차 엄수. (최종 목표: ${targetRecord}m)`; delete pbDive.difficultyAdjustments; delete pbDive._template; exercises.push(pbDive); } } if (level !== 'beginner') { let co2DiveType = 'CO2 CWT'; if (targetDiscipline === 'FIM') co2DiveType = 'CO2 FIM'; else if (targetDiscipline === 'CNF') co2DiveType = 'CO2 CNF'; const co2DiveTemplate = allOpenWaterTemplates.find(ex => ex.name === co2DiveType); if (co2DiveTemplate) { let co2Dive = deepCopy(co2DiveTemplate); let baseDepthForCO2 = currentIntermediateTargetPb > currentPb ? currentIntermediateTargetPb : currentPb; let co2TargetDepth = Math.round(baseDepthForCO2 * 0.6); if (level === 'intermediate') co2TargetDepth = Math.min(25, co2TargetDepth); else if (level === 'advanced') co2TargetDepth = Math.min(35, co2TargetDepth); co2TargetDepth = Math.max(15, co2TargetDepth); let co2TargetRange = `${Math.max(15, Math.round(co2TargetDepth * 0.8))}-${co2TargetDepth}m`; if(co2Dive.difficultyAdjustments && co2Dive.difficultyAdjustments[level]){ const effectText = co2Dive.difficultyAdjustments[level].split('/')[1]?.trim() || 'CO2 내성 훈련'; co2Dive.difficultyAdjustments[level] = `${co2TargetRange} / ${effectText}`; } else { if(!co2Dive.difficultyAdjustments) co2Dive.difficultyAdjustments = {}; co2Dive.difficultyAdjustments[level] = `${co2TargetRange} / CO2 내성 훈련`; } delete co2Dive._template; exercises.push(co2Dive); } } let transitionDrillTemplate = null; if (targetDiscipline === 'CNF') { transitionDrillTemplate = allOpenWaterTemplates.find(ex => ex.name.includes("FIM -> CNF 전환")); } else { transitionDrillTemplate = allOpenWaterTemplates.find(ex => ex.name.includes("FIM -> CWT 전환")); } if (transitionDrillTemplate) { let transitionDrill = deepCopy(transitionDrillTemplate); delete transitionDrill._template; exercises.push(transitionDrill); } return [...new Map(exercises.map(item => [item.name, item])).values()]; }

    // --- Add Exercise Category and Content (동일) ---
    function addCategoryAndExercises(container, categoryName, exercises, includeExplanations, level, dayNum) { /* ... */ if (!container || !Array.isArray(exercises) || exercises.length === 0) return; const categoryDiv = document.createElement('div'); categoryDiv.className = 'exercise-category'; categoryDiv.textContent = categoryName; container.appendChild(categoryDiv); const list = document.createElement('ul'); list.className = 'list-disc'; exercises.forEach((ex, index) => { if (!ex || typeof ex !== 'object' || !ex.name) { console.warn("Skipping invalid exercise object in addCategory:", ex); return; } const li = document.createElement('li'); const sanitizedCategoryName = sanitizeForId(categoryName); const checkboxId = `ex-d${dayNum}-${sanitizedCategoryName}-${index}`; const label = document.createElement('label'); label.htmlFor = checkboxId; const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = checkboxId; checkbox.className = 'exercise-checkbox'; const textSpan = document.createElement('span'); textSpan.className = 'exercise-text'; let baseText = ex.name; if (ex.sets) baseText += ` <span class="sets">${ex.sets}세트</span>`; if (ex.reps) baseText += ` <span class="duration">${ex.reps}</span>`; if (ex.distance) baseText += ` <span class="duration">${ex.distance}</span>`; if (ex.duration && !ex.reps && !ex.distance) baseText += ` <span class="duration">${ex.duration}</span>`; textSpan.innerHTML = baseText; label.appendChild(checkbox); label.appendChild(textSpan); li.appendChild(label); if (includeExplanations) { const detailsDiv = document.createElement('div'); detailsDiv.className = 'exercise-details'; let detailsContent = ''; if (ex.method) detailsContent += `<div class='exercise-info'>${ex.method}${ex.effect ? ` – ${ex.effect}` : ''}</div>`; else if (ex.effect) detailsContent += `<div class='exercise-info'>효과: ${ex.effect}</div>`; const difficultyText = ex.difficultyAdjustments?.[level]; if (difficultyText) detailsContent += `<div class='difficulty-info'><strong>[${level?.charAt(0).toUpperCase() + level?.slice(1)} 레벨]</strong> ${difficultyText}</div>`; else if (ex.difficultyAdjustments && typeof ex.difficultyAdjustments === 'string') detailsContent += `<div class='difficulty-info'>${ex.difficultyAdjustments}</div>`; if (ex.caution) detailsContent += `<div class='caution'><strong>주의:</strong> ${ex.caution}</div>`; if (ex.rest) detailsContent += `<div class='exercise-info'>휴식: ${ex.rest}</div>`; if (detailsContent) { detailsDiv.innerHTML = detailsContent; li.appendChild(detailsDiv); } } list.appendChild(li); }); if (list.children.length > 0) container.appendChild(list); }
    // --- Add Nutrition Plan (동일) ---
    function addNutritionPlan(container, planKey, includeExplanations) { /* ... */ if (!container || !data.nutrition) { return;} const mealPlan = data.nutrition[planKey] || data.nutrition.general || []; const supplements = data.nutrition.supplements || []; if (mealPlan.length === 0 && supplements.length === 0) { return; } const nutritionCategory = document.createElement('div'); nutritionCategory.className = 'nutrition-category'; nutritionCategory.textContent = '영양 계획 (식사 & 보충제)'; container.appendChild(nutritionCategory); const nutritionContent = document.createElement('div'); if (mealPlan.length > 0) { mealPlan.forEach(meal => { if (!meal || typeof meal !== 'object') return; const mealDiv = document.createElement('div'); mealDiv.className = 'nutrition-item'; let mealText = `<strong>${meal.mealTime || '식사'} 식단:</strong> ${meal.suggestion || '추천 없음'}`; if (includeExplanations && meal.focus) { mealText += `<div class='nutrition-info'>${meal.focus}</div>`; } mealDiv.innerHTML = mealText; nutritionContent.appendChild(mealDiv); }); } else { if (supplements.length > 0) { const noMealInfo = document.createElement('p'); noMealInfo.textContent = '추천 식단 정보가 없습니다.'; noMealInfo.style.fontStyle = 'italic'; noMealInfo.style.fontSize='0.85rem'; noMealInfo.style.marginLeft = '10px'; nutritionContent.appendChild(noMealInfo); } } const randomSupplements = getRandomItems(supplements, 2); if (randomSupplements.length > 0) { const supplementDiv = document.createElement('div'); supplementDiv.className = 'nutrition-item'; let supplementText = `<strong>보충제 (필요시):</strong> ${randomSupplements.map(s => s?.name || '알 수 없음').join(', ')}`; if (includeExplanations) { randomSupplements.forEach(s => { if (s?.name && s?.effect) supplementText += `<div class='nutrition-info'>${s.name}: ${s.effect}</div>`; else if (s?.effect) supplementText += `<div class='nutrition-info'>${s.effect}</div>`; }); } supplementDiv.innerHTML = supplementText; nutritionContent.appendChild(supplementDiv); } if (nutritionContent.hasChildNodes()) { container.appendChild(nutritionContent); } else { container.removeChild(nutritionCategory); } }
    // --- Loader, Print, Share, URL Functions (동일) ---
    function showLoader(message = "처리 중...") { const loader = document.getElementById('loader'); const loaderText = document.getElementById('loaderText'); if (loader && loaderText) { loaderText.textContent = message; loader.style.display = 'flex'; } else { console.error("Loader elements not found"); } } function hideLoader() { const loader = document.getElementById('loader'); if (loader) loader.style.display = 'none'; } function printSchedule() { const userName = document.getElementById('userName')?.value || '사용자'; const targetDiscipline = document.getElementById('targetDiscipline')?.value || 'N/A'; const currentPb = document.getElementById('currentPb')?.value || 'N/A'; const targetRecord = document.getElementById('targetRecord')?.value || 'N/A'; const trainingDays = document.getElementById('trainingDays')?.value || 'N/A'; const includeNutrition = document.getElementById('includeNutrition')?.value === 'yes'; const printUserTitle = document.getElementById('printUserNameTitle'); const printParams = document.getElementById('printParams'); if(printUserTitle) printUserTitle.textContent = `${userName}님의 딥 프리다이빙 트레이닝 계획`; if(printParams) printParams.innerHTML = `종목: ${targetDiscipline} | 현재 PB: ${currentPb}m | 목표 PB: ${targetRecord}m | 기간: ${trainingDays}일<br> 생성일: ${new Date().toLocaleDateString('ko-KR')} | 영양 정보: ${includeNutrition ? '포함' : '미포함'}`; const printHeader = document.getElementById('printHeaderInfo'); if(printHeader) printHeader.style.display = 'block'; const nutritionTipsContainer = document.getElementById('generalNutritionTipsContainer'); const precautionsContainer = document.getElementById('trainingPrecautionsContainer'); if(precautionsContainer) precautionsContainer.style.display = 'block'; /* Show precautions on print */ if (includeNutrition && nutritionTipsContainer && nutritionTipsContainer.innerHTML.trim() !== '') nutritionTipsContainer.style.display = 'block'; else if (nutritionTipsContainer) nutritionTipsContainer.style.display = 'none'; window.print(); } function openShareModal() { const modal = document.getElementById('shareModal'); if (modal) modal.style.display = 'flex'; } function closeShareModal() { const modal = document.getElementById('shareModal'); if (modal) modal.style.display = 'none'; } function generateShareUrl() { const params = new URLSearchParams(); const getVal = (id) => document.getElementById(id)?.value; const getChecked = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value).join(','); params.set('name', getVal('userName') || ''); params.set('discipline', getVal('targetDiscipline') || 'CWT'); params.set('cpb', getVal('currentPb') || '0'); params.set('tr', getVal('targetRecord') || '0'); params.set('days', getVal('trainingDays') || '14'); params.set('nutrition', getVal('includeNutrition') || 'yes'); params.set('explain', getVal('includeExplanations') || 'yes'); params.set('types', getChecked('trainingType')); const finalParams = new URLSearchParams(); for (const [key, value] of params.entries()) if (value) finalParams.set(key, value); return `${window.location.origin}${window.location.pathname}?${finalParams.toString()}`; } function shareViaLink() { const url = generateShareUrl(); navigator.clipboard.writeText(url).then(() => { alert("스케줄 링크가 클립보드에 복사되었습니다."); closeShareModal(); }, err => { console.error('Clipboard API failed: ', err); prompt("클립보드 복사 실패. 아래 링크를 직접 복사하세요:", url); closeShareModal(); }); } function shareViaEmail() { const url = generateShareUrl(); const subject = `${document.getElementById('userName')?.value || '프리다이버'}님의 트레이닝 스케줄`; const body = `안녕하세요,\n\n요청하신 프리다이빙 트레이닝 스케줄 링크입니다:\n${url}\n\n안전하고 즐거운 다이빙 되세요!`; window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; closeShareModal(); } function shareViaSocialMedia() { const url = generateShareUrl(); const text = `저의 프리다이빙 ${document.getElementById('targetDiscipline')?.value || ''} ${document.getElementById('targetRecord')?.value || ''}m 도전 계획을 확인해보세요!`; if (navigator.share) { navigator.share({ title: '프리다이빙 트레이닝 계획', text: text, url: url, }).then(() => console.log('Successful share')).catch((error) => console.log('Error sharing', error)); } else { alert(`SNS 공유:\n제목: ${text}\n링크: ${url}\n\n위 내용을 복사하여 원하는 SNS에 공유하세요.`); } closeShareModal(); } function loadFromUrlParams() { const params = new URLSearchParams(window.location.search); const setValue = (id, value, defaultValue) => { const element = document.getElementById(id); if (element) element.value = value !== null ? value : defaultValue; }; const setCheckboxes = (name, valuesString) => { const checkedValues = valuesString ? valuesString.split(',') : []; const defaultCheck = valuesString === null; document.querySelectorAll(`input[name="${name}"]`).forEach(cb => { cb.checked = defaultCheck || checkedValues.includes(cb.value); }); }; setValue('userName', params.get('name'), ''); setValue('targetDiscipline', params.get('discipline'), 'CWT'); setValue('currentPb', params.get('cpb'), ''); setValue('targetRecord', params.get('tr'), ''); setValue('trainingDays', params.get('days'), '14'); setValue('includeNutrition', params.get('nutrition'), 'yes'); setValue('includeExplanations', params.get('explain'), 'yes'); setCheckboxes('trainingType', params.get('types')); updateExperienceLevel(); }

    // --- Page Load Logic (DOMContentLoaded - 최종 안정화 버전) ---
    document.addEventListener('DOMContentLoaded', function() { console.log("DOM Loaded. Starting setup..."); if (typeof data === 'undefined' || !data || Object.keys(data).length === 0) { console.error("CRITICAL ERROR: Global 'data' object is not defined or empty!"); alert("데이터 로딩 오류! 페이지를 새로고침하세요."); const generateButton = document.querySelector('button[onclick="generateScheduleWrapper()"]'); if (generateButton) generateButton.disabled = true; return; } console.log("Data object check passed."); const criticalElementIds = [ 'userName', 'targetDiscipline', 'currentPb', 'targetRecord', 'trainingDays', 'experienceLevel', 'includeNutrition', 'includeExplanations', 'scheduleContainer', 'generalNutritionTipsContainer', 'trainingPrecautionsContainer', /* Added */ 'printUserNameTitle', 'printParams', 'subTitle', 'shareModal', 'loader', 'loaderText' ]; let allElementsFound = true; console.log("Checking for critical HTML elements..."); criticalElementIds.forEach(id => { const element = document.getElementById(id); if (!element) { console.error(`CRITICAL HTML ERROR: Element with ID '${id}' not found!`); allElementsFound = false; } }); if (!allElementsFound) { alert("페이지 HTML 구조 오류 발생. 필수 요소 누락. 콘솔(F12) 확인."); const genButton = document.querySelector('button[onclick="generateScheduleWrapper()"]'); if(genButton) genButton.disabled = true; return; } console.log("Critical element check passed."); try { console.log("Setting up listeners..."); const targetRecordInput = document.getElementById('targetRecord'); targetRecordInput.addEventListener('input', updateExperienceLevel); targetRecordInput.addEventListener('change', updateExperienceLevel); console.log("Target record listeners added."); console.log("Calling loadFromUrlParams..."); loadFromUrlParams(); console.log("loadFromUrlParams finished."); console.log("Setting initial message in schedule container."); const scheduleContainer = document.getElementById('scheduleContainer'); scheduleContainer.innerHTML = '<p style="text-align: center; color: #555; margin-top: 2rem;">훈련 계획을 보려면 현재 PB와 목표 수심을 입력(또는 확인)하고 \'스케줄 생성하기\'를 클릭하세요.</p>'; scheduleContainer.className = ''; console.log("Setting up modal listener..."); const modal = document.getElementById('shareModal'); window.onclick = function(event) { if (event.target === modal) { closeShareModal(); } }; console.log("Modal listener setup complete."); console.log("DOMContentLoaded setup fully completed."); } catch (error) { console.error("Error during DOMContentLoaded setup:", error); alert(`페이지 초기화 중 오류 발생:\n${error.message}\n\n콘솔(F12)을 확인하여 관련 코드를 점검하세요.`); try { hideLoader(); } catch(e) {} } });
  </script>
</body>
</html>